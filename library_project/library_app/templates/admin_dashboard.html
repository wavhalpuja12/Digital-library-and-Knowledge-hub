{% extends 'adminbase.html' %}

{% load static %}

{% block content %}

{% load static %}
<div class="content">
  <h2>Admin Dashboard</h2>

  <a href="{% url 'add_book' %}" class="btn-add">+ Add New Book</a>

  <!-- STATS -->
  <div class="cards" style="margin-top: 20px">
    <div class="card">
      <h3>Total Books</h3>
      <p>{{ total_books }}</p>
    </div>

    <div class="card">
      <h3>Issued Books</h3>
      <p>{{ issued_books }}</p>
    </div>

    <div class="card">
      <h3>Available Books</h3>
      <p>{{ available_books }}</p>
    </div>

    <div class="card">
      <h3>Total Users</h3>
      <p>{{ total_users }}</p>
    </div>
  </div>

  <!-- FILTER -->
  <form method="get" class="filter-box">
    <select name="category">
      <option value="">All Categories</option>

      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if selected_category == "cat.id" %}selected{% endif %}>
        {{ cat.name }}
      </option>

      {% for sub in cat.children.all %}
      <option value="{{ sub.id }}" {% if selected_category == "sub.id" %}selected{% endif %}>
        â†³ {{ sub.name }}
      </option>
      {% endfor %} {% endfor %}
    </select>

    <input type="text" name="search" placeholder="Search title or author" value="{{ search_query }}" />

    <button type="submit" class="btn-add">Apply</button>

    {% if selected_category or search_query %}
    <a href="{% url 'admin_dashboard' %}" style="
              background: red;
              color: white;
              padding: 8px 15px;
              border-radius: 5px;
            ">
      Clear
    </a>
    {% endif %}
  </form>

  <!-- BOOK TABLE -->
  <table>
    <tr>
      <th>Book</th>
      <th>Author</th>
      <th>Category</th>
      <th>Status</th>
      <th>Action</th>
    </tr>

    {% for book in books %}
    <tr>
      <td>{{ book.title }}</td>
      <td>{{ book.author }}</td>
      <td>{{ book.category.name|default:"Uncategorized" }}</td>
      <td>
        {% if book.is_availible %}Available{% else %}Borrowed{% endif %}
      </td>
      <td>
        <a href="{% url 'delete_book' book.id %}" class="btn-delete">Delete</a>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4" style="text-align: center">No books found</td>
    </tr>
    {% endfor %}
  </table>

  <!-- RECENT RECORDS -->
  <h2 style="margin-top: 40px">Recent Borrow Records</h2>

  <table>
    <tr>
      <th>User</th>
      <th>Book</th>
    </tr>

    {% for record in records %}
    <tr>
      <td>{{ record.user.username }}</td>
      <td>{{ record.book.title }}</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="2" style="text-align: center">No records</td>
    </tr>
    {% endfor %}
  </table>
</div>


{% endblock %}